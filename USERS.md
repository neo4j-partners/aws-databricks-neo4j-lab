# Phase 4 Implementation Plan: Workshop User Management — IMPLEMENTED

A standalone CLI tool in `lab_setup/user_mngmnt/` that reads workshop participant emails from a CSV file and adds them to the `workshop-users` group in Databricks.

---

## Why a Separate Tool

The existing `auto_scripts/` CLI handles workspace-level infrastructure: clusters, volumes, tables, and permissions. User management is a different concern with a different lifecycle. Instructors may need to add or remove participants multiple times during a workshop without touching infrastructure. A separate tool keeps the responsibilities clean and avoids coupling user roster changes to the full setup/cleanup flow.

---

## What It Does

The tool reads a CSV file containing participant email addresses, connects to the Databricks workspace, and ensures every listed user is a member of the `workshop-users` group. It also supports removing users from the group and listing current group members.

### Commands

The CLI has three commands:

1. **add** — Read emails from the CSV, find each user in the workspace, and add them to the `workshop-users` group. Skip any email that does not match an existing workspace user and report it. Skip users who are already in the group. Report a summary at the end showing how many were added, how many were already members, and how many were not found.

2. **remove** — Read emails from the CSV and remove those users from the `workshop-users` group. Skip any email that is not currently a member. Report how many were removed and how many were not found.

3. **list** — Display all current members of the `workshop-users` group with their email and display name. No CSV file needed for this command.

All three commands are idempotent. Running add twice with the same CSV produces the same result. Running remove for a user who is not in the group does not error.

---

## CSV File Format

The CSV file has a single required column: `email`. An optional `name` column can be included for human readability but is ignored by the tool. The tool matches users against the workspace by email address only.

Example:

```
email,name
alice@example.com,Alice Johnson
bob@example.com,Bob Smith
carol@example.com,Carol Williams
```

The file defaults to `users.csv` in the current directory. The path can be overridden with a `--file` flag on the add and remove commands.

A sample placeholder file is provided at `lab_setup/user_mngmnt/users.csv` with fictional emails.

---

## How It Works

### Connecting to the workspace

Authentication follows the same pattern as `auto_scripts/`: the Databricks SDK reads credentials from the environment, a `.databrickscfg` profile, or environment variables. The tool accepts an optional `--profile` flag to select a specific Databricks CLI profile, matching the `DATABRICKS_PROFILE` variable used by `auto_scripts/`.

The tool shares the same `.env` file at `lab_setup/.env` for convenience, so instructors do not need to configure credentials in two places. It loads environment variables from that file using `python-dotenv`.

### Finding the group

The tool looks up the `workshop-users` group by display name using the SCIM groups list endpoint. If the group does not exist, the add command creates it (same logic as Phase 2 in `permissions.py`). The remove and list commands report an error if the group does not exist.

The group name defaults to `workshop-users` and can be overridden with a `--group` flag or the `GROUP_NAME` environment variable for consistency with any future config changes.

### Adding users

For each email in the CSV:

1. Look up the user in the workspace by email using the SCIM users list endpoint with a filter.
2. If the user is not found in the workspace, log a warning and skip. The user must already exist in the workspace — this tool does not create workspace accounts.
3. Check if the user is already a member of the group. If so, skip.
4. Add the user to the group using a SCIM group patch operation.

All user lookups happen first, then all additions happen in a single batch SCIM patch call. This minimizes API calls. If the batch is large (over 50 users), split into multiple patch calls.

### Removing users

For each email in the CSV:

1. Look up the user in the workspace by email.
2. If found and currently a member, remove them from the group via SCIM patch.
3. If not found or not a member, skip and log.

### Listing members

Retrieve the group details including members. For each member, fetch their display name and email. Display as a formatted table using Rich.

---

## Project Structure — IMPLEMENTED

```
lab_setup/user_mngmnt/
├── pyproject.toml              ← hatchling build, same deps as auto_scripts
├── users.csv                   ← sample placeholder (3 fictional emails)
├── uv.lock                     ← generated by uv sync
├── .venv/                      ← generated by uv sync
├── src/
│   └── user_mngmnt/
│       ├── __init__.py
│       ├── main.py             ← typer CLI: add, remove, list commands
│       ├── groups.py           ← find/create group, add/remove members (batched)
│       └── users.py            ← CSV parsing, workspace user lookup by email
```

### Dependencies

The same stack as `auto_scripts/`:

- `databricks-sdk` — workspace API access
- `python-dotenv` — load `.env` file
- `typer` — CLI framework
- `rich` — formatted terminal output

No new dependencies beyond what the project already uses.

### Build and install

Uses `uv` and `hatchling`, same as `auto_scripts/`. The pyproject.toml defines a script entry point:

```
[project.scripts]
user-mngmnt = "user_mngmnt.main:app"
```

Install and run:

```bash
cd lab_setup/user_mngmnt
uv sync
uv run user-mngmnt add --file users.csv
uv run user-mngmnt list
uv run user-mngmnt remove --file users.csv
```

---

## CLI Interface

### add

```
user-mngmnt add [--file PATH] [--profile NAME] [--group NAME]
```

Reads the CSV and adds all listed users to the workshop group. Prints a summary table:

| Status | Count |
|---|---|
| Added | 12 |
| Already member | 3 |
| Not found in workspace | 2 |
| Total in CSV | 17 |

### remove

```
user-mngmnt remove [--file PATH] [--profile NAME] [--group NAME]
```

Reads the CSV and removes listed users from the group. Prints a summary.

### list

```
user-mngmnt list [--profile NAME] [--group NAME]
```

Displays current group members as a table:

| Email | Display Name |
|---|---|
| alice@example.com | Alice Johnson |
| bob@example.com | Bob Smith |

---

## Error Handling

- **Group does not exist (remove/list):** Print an error message and exit. Do not create the group — that is the add command's job.
- **CSV file not found:** Print an error message and exit.
- **CSV missing email column:** Print an error message and exit.
- **Duplicate emails in CSV:** Deduplicate silently before processing.
- **User is a workspace admin:** Add them to the group like any other user. The entitlement lockdown from Phase 1 does not affect admins, so adding them to the workshop group simply gives them the same view as participants.
- **API rate limits:** The batch approach (one patch call per 50 users) keeps API calls low. No retry logic needed for workshop-scale user counts (typically under 100).

---

## What to Test — PENDING LIVE TESTING

- [ ] Replace `users.csv` with real workshop participant emails
- [ ] Run `databricks-setup setup` first (creates group + permissions via Track C)
- [ ] Run `user-mngmnt add --file users.csv` — new users are added, missing users are reported, existing members are skipped
- [ ] Run `user-mngmnt list` — all added users appear
- [ ] Run `user-mngmnt add --file users.csv` again — idempotent, summary shows all as "already member"
- [ ] Run `user-mngmnt remove --file users.csv` — users are removed
- [ ] Run `user-mngmnt list` — group is empty (or only contains users not in the CSV)
- [ ] Run `user-mngmnt remove --file users.csv` again — idempotent, no errors
- [ ] Run `user-mngmnt list` when the group does not exist — clear error message

---

## What This Does NOT Do

- **Create workspace accounts.** Users must already exist in the Databricks workspace (typically via SCIM sync from an identity provider or manual invitation). This tool only manages group membership.
- **Manage the `admins` group.** It never touches admin group membership.
- **Restore entitlements.** That is a deliberate admin action, as noted in the LOCKDOWN.md cleanup section.
- **Replace the auto_scripts setup/cleanup flow.** This tool complements it — run `databricks-setup setup` first to create the group and set permissions, then run `user-mngmnt add` to populate it.

---

## Implementation Status

| Component | Status | Notes |
|---|---|---|
| `pyproject.toml` | Done | hatchling build, same dep stack as auto_scripts |
| `users.csv` sample | Done | 3 fictional placeholder emails |
| `src/user_mngmnt/users.py` | Done | CSV parsing (dedup, case-insensitive), SCIM user lookup |
| `src/user_mngmnt/groups.py` | Done | find/create group, membership ops, batched add (50/call) |
| `src/user_mngmnt/main.py` | Done | typer app with add/remove/list, Rich summary tables |
| `uv sync` build | Done | All deps resolve, CLI entry point verified |
| `ruff` lint | Done | Clean pass |
| Live testing against workspace | Pending | Requires real user emails in CSV |
