<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aircraft ETL to Neo4j - Databricks Notebook</title>
    <style>
        :root {
            --primary-color: #1b3a57;
            --accent-color: #ff6f00;
            --code-bg: #f6f8fa;
            --border-color: #e1e4e8;
            --text-color: #24292e;
            --text-secondary: #586069;
            --link-color: #0366d6;
            --success-color: #28a745;
            --warning-color: #f0ad4e;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            background: #fff;
        }

        .header {
            background: linear-gradient(135deg, #1b3a57 0%, #2d5a87 100%);
            color: white;
            padding: 2rem;
            border-bottom: 4px solid var(--accent-color);
        }

        .header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
            font-weight: 600;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }

        .header .badges {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-databricks {
            background: #ff3621;
            color: white;
        }

        .badge-neo4j {
            background: #018bff;
            color: white;
        }

        .badge-spark {
            background: #e25a1c;
            color: white;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        .toc {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .toc h2 {
            margin-top: 0;
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        .toc ul {
            margin: 0;
            padding-left: 1.5rem;
        }

        .toc li {
            margin: 0.5rem 0;
        }

        .toc a {
            color: var(--link-color);
            text-decoration: none;
        }

        .toc a:hover {
            text-decoration: underline;
        }

        .cell {
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .cell-header {
            background: var(--code-bg);
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cell-type {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .cell-type.python {
            color: #3776ab;
        }

        .cell-type.markdown {
            color: #083fa1;
        }

        .cell-number {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .cell-content {
            padding: 0;
        }

        .markdown-cell .cell-content {
            padding: 1rem 1.5rem;
        }

        .code-cell pre {
            margin: 0;
            padding: 1rem;
            background: #fafbfc;
            overflow-x: auto;
        }

        .code-cell code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #24292e;
        }

        .code-cell code .comment { color: #6a737d; }
        .code-cell code .string { color: #032f62; }
        .code-cell code .keyword { color: #d73a49; }

        .markdown-cell h1 {
            font-size: 1.8rem;
            margin-top: 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-color);
        }

        .markdown-cell h2 {
            font-size: 1.4rem;
            margin-top: 1.5rem;
            color: var(--primary-color);
        }

        .markdown-cell h3 {
            font-size: 1.15rem;
            color: var(--primary-color);
        }

        .markdown-cell ul, .markdown-cell ol {
            padding-left: 1.5rem;
        }

        .markdown-cell li {
            margin: 0.3rem 0;
        }

        .markdown-cell code {
            background: var(--code-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9em;
        }

        .markdown-cell pre {
            background: var(--code-bg);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
        }

        .markdown-cell pre code {
            background: none;
            padding: 0;
        }

        .section-divider {
            margin: 3rem 0;
            border: none;
            border-top: 2px solid var(--border-color);
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #0366d6;
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            border-radius: 0 6px 6px 0;
        }

        .warning-box {
            background: #fff8e6;
            border-left: 4px solid var(--warning-color);
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            border-radius: 0 6px 6px 0;
        }

        .graph-diagram {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            font-family: monospace;
            text-align: center;
            margin: 1rem 0;
        }

        .footer {
            background: var(--code-bg);
            border-top: 1px solid var(--border-color);
            padding: 2rem;
            text-align: center;
            color: var(--text-secondary);
            margin-top: 3rem;
        }

        .footer a {
            color: var(--link-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                padding: 1.5rem 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Aircraft ETL to Neo4j</h1>
        <div class="subtitle">Load Aircraft Digital Twin data from Databricks Unity Catalog into Neo4j Aura</div>
        <div class="badges">
            <span class="badge badge-databricks">Databricks</span>
            <span class="badge badge-neo4j">Neo4j</span>
            <span class="badge badge-spark">Spark Connector</span>
        </div>
    </div>

    <div class="container">
        <nav class="toc">
            <h2>Table of Contents</h2>
            <ul>
                <li><a href="#section1">Section 1: Configuration</a></li>
                <li><a href="#section2">Section 2: Data Preview</a></li>
                <li><a href="#section3">Section 3: Load Nodes to Neo4j</a></li>
                <li><a href="#section4">Section 4: Load Relationships to Neo4j</a></li>
                <li><a href="#section5">Section 5: Verification Queries</a></li>
                <li><a href="#section6">Section 6: Next Steps</a></li>
            </ul>
        </nav>

        <!-- Introduction -->
        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h1>Aircraft ETL to Neo4j</h1>
                <p>This notebook loads Aircraft, System, and Component data from Databricks Unity Catalog into Neo4j Aura using the Neo4j Spark Connector.</p>

                <h2>What You'll Learn</h2>
                <ul>
                    <li>How to read CSV data from Unity Catalog Volumes</li>
                    <li>How to transform tabular data for graph loading</li>
                    <li>How to write nodes and relationships using the Neo4j Spark Connector</li>
                    <li>How to verify data with Cypher queries from Databricks</li>
                </ul>

                <h2>Prerequisites</h2>
                <ul>
                    <li>Neo4j Aura credentials from Lab 1</li>
                    <li>Access to the workshop Databricks cluster (with Neo4j Spark Connector installed)</li>
                </ul>

                <h2>Instructions</h2>
                <ol>
                    <li>Clone this notebook to your personal folder</li>
                    <li>Enter your Neo4j credentials in the Configuration cell below</li>
                    <li>Run all cells in order (Shift+Enter or Run All)</li>
                    <li>Verify the results in the final cells</li>
                </ol>
            </div>
        </div>

        <hr class="section-divider">

        <!-- Section 1: Configuration -->
        <div id="section1" class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h2>Section 1: Configuration</h2>
                <p>Enter your Neo4j Aura connection details below. You received these credentials when you created your Neo4j Aura instance in Lab 1.</p>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 1</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># ============================================
# CONFIGURATION - Enter your Neo4j credentials
# ============================================

NEO4J_URI = ""  # e.g., "neo4j+s://xxxxxxxx.databases.neo4j.io"
NEO4J_USERNAME = "neo4j"
NEO4J_PASSWORD = ""  # Your password from Lab 1

# Unity Catalog Volume path (pre-configured by workshop admin)
DATA_PATH = "/Volumes/aircraft_workshop/aircraft_lab/aircraft_data"

# Validate configuration
if not NEO4J_URI or not NEO4J_PASSWORD:
    print("WARNING: Please enter your Neo4j credentials above before running the notebook!")
else:
    print("Configuration ready!")
    print(f"Neo4j URI: {NEO4J_URI}")
    print(f"Data Path: {DATA_PATH}")</code></pre>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 2</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Configure Neo4j Spark Connector
spark.conf.set("neo4j.url", NEO4J_URI)
spark.conf.set("neo4j.authentication.basic.username", NEO4J_USERNAME)
spark.conf.set("neo4j.authentication.basic.password", NEO4J_PASSWORD)
spark.conf.set("neo4j.database", "neo4j")

print("Spark configured for Neo4j connection")</code></pre>
            </div>
        </div>

        <hr class="section-divider">

        <!-- Section 2: Data Preview -->
        <div id="section2" class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h2>Section 2: Data Preview</h2>
                <p>Let's examine the CSV files that we'll load into Neo4j. The data represents an Aircraft Digital Twin with three entity types:</p>
                <ul>
                    <li><strong>Aircraft</strong>: Fleet of 20 aircraft with tail numbers, models, and operators</li>
                    <li><strong>System</strong>: Major systems on each aircraft (engines, avionics, hydraulics)</li>
                    <li><strong>Component</strong>: Parts within each system (fans, compressors, turbines, etc.)</li>
                </ul>
                <p>The graph structure will be:</p>
                <div class="graph-diagram">
                    <code>(Aircraft) -[:HAS_SYSTEM]-&gt; (System) -[:HAS_COMPONENT]-&gt; (Component)</code>
                </div>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 3</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Helper function to read CSV files
def read_csv(filename):
    """Read a CSV file from the Unity Catalog Volume."""
    path = f"{DATA_PATH}/{filename}"
    return spark.read.option("header", "true").csv(path)</code></pre>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 4</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Read all CSV files
aircraft_df = read_csv("nodes_aircraft.csv")
systems_df = read_csv("nodes_systems.csv")
components_df = read_csv("nodes_components.csv")

print("=" * 60)
print("DATA LOADED FROM UNITY CATALOG")
print("=" * 60)
print(f"Aircraft:   {aircraft_df.count()} rows")
print(f"Systems:    {systems_df.count()} rows")
print(f"Components: {components_df.count()} rows")
print("=" * 60)</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Aircraft Data</h3>
                <p>Each aircraft has a unique ID, tail number, model, manufacturer, and operator.</p>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 5</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python">display(aircraft_df)</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Systems Data</h3>
                <p>Each system belongs to an aircraft (via <code>aircraft_id</code>) and has a type (Engine, Avionics, Hydraulics).</p>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 6</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python">display(systems_df)</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Components Data</h3>
                <p>Each component belongs to a system (via <code>system_id</code>) and has a type (Fan, Compressor, Turbine, etc.).</p>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 7</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python">display(components_df)</code></pre>
            </div>
        </div>

        <hr class="section-divider">

        <!-- Section 3: Load Nodes to Neo4j -->
        <div id="section3" class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h2>Section 3: Load Nodes to Neo4j</h2>
                <p>Now we'll write the data to Neo4j as graph nodes. The Neo4j Spark Connector writes DataFrames directly to Neo4j.</p>
                <p><strong>Key Concepts:</strong></p>
                <ul>
                    <li>Each DataFrame row becomes a node</li>
                    <li>Column values become node properties</li>
                    <li>The <code>labels</code> option sets the node label (e.g., <code>:Aircraft</code>)</li>
                    <li>The <code>node.keys</code> option identifies the unique key property</li>
                </ul>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 8</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Helper function to write nodes
def write_nodes(df, label, id_column):
    """Write a DataFrame as nodes to Neo4j."""
    (df
     .write
     .format("org.neo4j.spark.DataSource")
     .mode("Overwrite")
     .option("labels", f":{label}")
     .option("node.keys", id_column)
     .save())
    count = df.count()
    print(f"Wrote {count} {label} nodes to Neo4j")
    return count</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Transform and Load Aircraft Nodes</h3>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 9</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Transform: Rename the ID column from Neo4j import format to standard name
aircraft_clean = aircraft_df.withColumnRenamed(":ID(Aircraft)", "aircraft_id")

# Show the transformed schema
print("Aircraft schema:")
aircraft_clean.printSchema()</code></pre>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 10</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Write Aircraft nodes to Neo4j
aircraft_count = write_nodes(aircraft_clean, "Aircraft", "aircraft_id")</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Transform and Load System Nodes</h3>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 11</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Transform System data
systems_clean = systems_df.withColumnRenamed(":ID(System)", "system_id")

# Write System nodes to Neo4j
systems_count = write_nodes(systems_clean, "System", "system_id")</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Transform and Load Component Nodes</h3>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 12</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Transform Component data
components_clean = components_df.withColumnRenamed(":ID(Component)", "component_id")

# Write Component nodes to Neo4j
components_count = write_nodes(components_clean, "Component", "component_id")</code></pre>
            </div>
        </div>

        <hr class="section-divider">

        <!-- Section 4: Load Relationships to Neo4j -->
        <div id="section4" class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h2>Section 4: Load Relationships to Neo4j</h2>
                <p>Now we'll create the relationships that connect our nodes:</p>
                <ul>
                    <li><code>HAS_SYSTEM</code>: Connects Aircraft to their Systems</li>
                    <li><code>HAS_COMPONENT</code>: Connects Systems to their Components</li>
                </ul>
                <p><strong>Key Concepts:</strong></p>
                <ul>
                    <li>The <code>relationship</code> option specifies the relationship type</li>
                    <li>The <code>relationship.save.strategy</code> of <code>keys</code> matches nodes by their key properties</li>
                    <li>Source and target labels/keys identify which nodes to connect</li>
                </ul>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 13</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Helper function to write relationships
def write_relationships(df, rel_type, source_label, source_key, target_label, target_key):
    """Write relationships to Neo4j using keys strategy."""
    (df
     .write
     .format("org.neo4j.spark.DataSource")
     .mode("Overwrite")
     .option("relationship", rel_type)
     .option("relationship.save.strategy", "keys")
     .option("relationship.source.labels", f":{source_label}")
     .option("relationship.source.node.keys", source_key)
     .option("relationship.target.labels", f":{target_label}")
     .option("relationship.target.node.keys", target_key)
     .save())
    count = df.count()
    print(f"Wrote {count} {rel_type} relationships to Neo4j")
    return count</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Load HAS_SYSTEM Relationships</h3>
                <p>Connect each Aircraft to its Systems.</p>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 14</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Read and transform relationship data
aircraft_system_df = read_csv("rels_aircraft_system.csv")

# Rename columns to match our node keys
aircraft_system_clean = (aircraft_system_df
    .withColumnRenamed(":START_ID(Aircraft)", "aircraft_id")
    .withColumnRenamed(":END_ID(System)", "system_id"))

print("HAS_SYSTEM relationship data:")
display(aircraft_system_clean.limit(5))</code></pre>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 15</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Write HAS_SYSTEM relationships
has_system_count = write_relationships(
    aircraft_system_clean,
    "HAS_SYSTEM",
    "Aircraft", "aircraft_id",
    "System", "system_id"
)</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Load HAS_COMPONENT Relationships</h3>
                <p>Connect each System to its Components.</p>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 16</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Read and transform relationship data
system_component_df = read_csv("rels_system_component.csv")

# Rename columns to match our node keys
system_component_clean = (system_component_df
    .withColumnRenamed(":START_ID(System)", "system_id")
    .withColumnRenamed(":END_ID(Component)", "component_id"))

print("HAS_COMPONENT relationship data:")
display(system_component_clean.limit(5))</code></pre>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 17</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Write HAS_COMPONENT relationships
has_component_count = write_relationships(
    system_component_clean,
    "HAS_COMPONENT",
    "System", "system_id",
    "Component", "component_id"
)</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h2>ETL Complete!</h2>
                <p>Summary of data loaded to Neo4j:</p>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 18</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python">print("=" * 60)
print("ETL COMPLETE!")
print("=" * 60)
print()
print("NODES LOADED:")
print(f"  Aircraft:   {aircraft_count}")
print(f"  System:     {systems_count}")
print(f"  Component:  {components_count}")
print(f"  ---------------------")
print(f"  Total:      {aircraft_count + systems_count + components_count}")
print()
print("RELATIONSHIPS LOADED:")
print(f"  HAS_SYSTEM:    {has_system_count}")
print(f"  HAS_COMPONENT: {has_component_count}")
print(f"  ---------------------")
print(f"  Total:         {has_system_count + has_component_count}")
print()
print("=" * 60)</code></pre>
            </div>
        </div>

        <hr class="section-divider">

        <!-- Section 5: Verification Queries -->
        <div id="section5" class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h2>Section 5: Verification Queries</h2>
                <p>Let's verify the data loaded correctly by running Cypher queries from Databricks.</p>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 19</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python"># Helper function to run Cypher queries
def run_cypher(query):
    """Execute a Cypher query and return results as DataFrame."""
    return (spark.read
        .format("org.neo4j.spark.DataSource")
        .option("query", query)
        .load())</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Verify Node Counts</h3>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 20</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python">print("Node counts by label:")
result = run_cypher("""
    MATCH (n)
    RETURN labels(n)[0] AS NodeType, count(*) AS Count
    ORDER BY NodeType
""")
display(result)</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Verify Relationship Counts</h3>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 21</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python">print("Relationship counts by type:")
result = run_cypher("""
    MATCH ()-[r]->()
    RETURN type(r) AS RelType, count(*) AS Count
    ORDER BY RelType
""")
display(result)</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Sample Query: Aircraft Hierarchy</h3>
                <p>View the complete hierarchy for aircraft N95040A (a Boeing 737-800).</p>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 22</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python">result = run_cypher("""
    MATCH (a:Aircraft {tail_number: 'N95040A'})-[:HAS_SYSTEM]->(s:System)
    OPTIONAL MATCH (s)-[:HAS_COMPONENT]->(c:Component)
    RETURN a.tail_number AS Aircraft,
           a.model AS Model,
           s.name AS System,
           s.type AS SystemType,
           collect(c.name) AS Components
    ORDER BY s.type, s.name
""")
display(result)</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Sample Query: Fleet by Manufacturer</h3>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 23</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python">result = run_cypher("""
    MATCH (a:Aircraft)
    RETURN a.manufacturer AS Manufacturer,
           count(a) AS AircraftCount,
           collect(a.model) AS Models
    ORDER BY AircraftCount DESC
""")
display(result)</code></pre>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h3>Sample Query: Component Distribution</h3>
            </div>
        </div>

        <div class="cell code-cell">
            <div class="cell-header">
                <span class="cell-type python">Python</span>
                <span class="cell-number">Cmd 24</span>
            </div>
            <div class="cell-content">
                <pre><code class="language-python">result = run_cypher("""
    MATCH (c:Component)
    RETURN c.type AS ComponentType, count(c) AS Count
    ORDER BY Count DESC
""")
display(result)</code></pre>
            </div>
        </div>

        <hr class="section-divider">

        <!-- Section 6: Next Steps -->
        <div id="section6" class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h2>Section 6: Next Steps - Explore in Neo4j Aura</h2>
                <p>Now that the data is loaded, open your Neo4j Aura console to visualize the graph!</p>

                <h3>How to Access Neo4j Aura</h3>
                <ol>
                    <li>Go to <a href="https://console.neo4j.io" target="_blank">console.neo4j.io</a></li>
                    <li>Sign in with your Neo4j account</li>
                    <li>Click on your instance</li>
                    <li>Click <strong>Query</strong> to open the query interface</li>
                </ol>

                <h3>Visualization Queries to Try</h3>

                <p><strong>See one aircraft's complete hierarchy:</strong></p>
                <pre><code class="language-cypher">MATCH (a:Aircraft {tail_number: 'N95040A'})-[r1:HAS_SYSTEM]->(s:System)-[r2:HAS_COMPONENT]->(c:Component)
RETURN a, r1, s, r2, c</code></pre>

                <p><strong>Compare aircraft by operator:</strong></p>
                <pre><code class="language-cypher">MATCH (a:Aircraft)
RETURN a.operator AS Operator, count(a) AS Count</code></pre>

                <p><strong>Find all engine components:</strong></p>
                <pre><code class="language-cypher">MATCH (s:System {type: 'Engine'})-[:HAS_COMPONENT]->(c:Component)
RETURN DISTINCT c.type AS ComponentType, count(c) AS Count
ORDER BY Count DESC</code></pre>

                <h3>Exploration Tips</h3>
                <ul>
                    <li>Click on nodes in the visualization to see their properties</li>
                    <li>Double-click to expand connected nodes</li>
                    <li>Use the styling panel to color nodes by property (e.g., manufacturer)</li>
                </ul>
            </div>
        </div>

        <div class="cell markdown-cell">
            <div class="cell-header">
                <span class="cell-type markdown">Markdown</span>
            </div>
            <div class="cell-content">
                <h2>Congratulations!</h2>
                <p>You have successfully:</p>
                <ul>
                    <li>Read CSV data from Databricks Unity Catalog</li>
                    <li>Transformed tabular data for graph loading</li>
                    <li>Written nodes and relationships to Neo4j using the Spark Connector</li>
                    <li>Verified the data with Cypher queries</li>
                </ul>
                <div class="info-box">
                    <strong>Continue to Part E</strong> to explore the graph visualization in Neo4j Aura!
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Aircraft ETL to Neo4j | Databricks + Neo4j Workshop</p>
        <p>
            <a href="https://neo4j.com/docs/spark" target="_blank">Neo4j Spark Connector Docs</a> |
            <a href="https://docs.databricks.com" target="_blank">Databricks Documentation</a>
        </p>
    </div>

</body>
</html>
